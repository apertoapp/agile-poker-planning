<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agile Poker Planning</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
    <h1>üéØ Agile Poker Planning</h1>
    <p class="subtitle">
        Planning Poker en temps r√©el - Choisissez votre r√¥le
    </p>

    <!-- Choix du r√¥le -->
    <div id="roleChoice">
        <div class="role-buttons">
            <button class="role-btn facilitator" onclick="showFacilitatorForm()">
                üé¨ Je suis le facilitateur
            </button>
            <button class="role-btn participant" onclick="showParticipantForm()">
                üë• Je suis un participant
            </button>
        </div>
    </div>

    <!-- Formulaire Facilitateur -->
    <div id="facilitatorForm" class="hidden">
        <div class="form-box">
            <button class="back-link" onclick="showRoleChoice()">‚Üê Retour</button>
            <h2>üé¨ Facilitateur</h2>
            <p class="form-description">Cr√©ez une nouvelle session et invitez votre √©quipe</p>

            <label for="facilitatorName" class="visually-hidden">Votre nom</label>
            <input
                    type="text"
                    id="facilitatorName"
                    placeholder="Votre nom (ex: Claude)"
                    maxlength="20"
                    autocomplete="off"
            >

            <button class="btn btn-primary" onclick="createSession()">
                ‚ûï Cr√©er une nouvelle session
            </button>

            <div class="divider">
                <span>OU</span>
            </div>

            <div class="join-existing">
                <p class="hint">Si vous avez d√©j√† une session en cours :</p>
                <label for="facilitatorSessionCode" class="visually-hidden">Code de session</label>
                <input
                        type="text"
                        id="facilitatorSessionCode"
                        placeholder="Code de session (ex: equipe37)"
                        maxlength="20"
                        autocomplete="off"
                        class="session-code-input"
                >
                <button class="btn btn-secondary" onclick="joinAsRole('facilitator')">
                    Rejoindre ma session
                </button>
            </div>
        </div>
    </div>

    <!-- Formulaire Participant -->
    <div id="participantForm" class="hidden">
        <div class="form-box">
            <button class="back-link" onclick="showRoleChoice()">‚Üê Retour</button>
            <h2>üë• Participant</h2>
            <p class="form-description">Rejoignez une session existante</p>

            <label for="participantName" class="visually-hidden">Votre nom</label>
            <input
                    type="text"
                    id="participantName"
                    placeholder="Votre nom (ex: Alice)"
                    maxlength="20"
                    autocomplete="off"
            >

            <label for="participantSessionCode" class="visually-hidden">Code de session</label>
            <input
                    type="text"
                    id="participantSessionCode"
                    placeholder="Code de session (ex: equipe37)"
                    maxlength="20"
                    autocomplete="off"
                    class="session-code-input"
            >

            <button class="btn btn-primary" onclick="joinAsRole('participant')">
                Rejoindre la session
            </button>

            <p class="hint">üí° Le facilitateur vous a partag√© le code de session</p>
        </div>
    </div>
</div>

<!-- Gun.js -->
<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<script>
    // V√©rifier si une session existe dans l'URL
    const urlParams = new URLSearchParams(window.location.search);
    const existingSessionId = urlParams.get('session');
    const roleFromUrl = urlParams.get('role');

    // Fonction de sanitization
    function sanitizeInput(input) {
        if (typeof input !== 'string') return '';
        return input.trim().slice(0, 200).replace(/[<>"'`]/g, '');
    }

    if (existingSessionId) {
        // Si URL avec session, proposer directement de rejoindre
        const sanitizedSession = sanitizeInput(existingSessionId);
        if (roleFromUrl === 'facilitator') {
            showFacilitatorForm();
            document.getElementById('facilitatorSessionCode').value = sanitizedSession;
        } else {
            showParticipantForm();
            document.getElementById('participantSessionCode').value = sanitizedSession;
        }
    }

    function showRoleChoice() {
        document.getElementById('roleChoice').classList.remove('hidden');
        document.getElementById('facilitatorForm').classList.add('hidden');
        document.getElementById('participantForm').classList.add('hidden');
    }

    function showFacilitatorForm() {
        document.getElementById('roleChoice').classList.add('hidden');
        document.getElementById('facilitatorForm').classList.remove('hidden');
        document.getElementById('participantForm').classList.add('hidden');
        document.getElementById('facilitatorName').focus();
    }

    function showParticipantForm() {
        document.getElementById('roleChoice').classList.add('hidden');
        document.getElementById('facilitatorForm').classList.add('hidden');
        document.getElementById('participantForm').classList.remove('hidden');
        document.getElementById('participantName').focus();
    }

    function createSession() {
        const nameInput = document.getElementById('facilitatorName');
        const playerName = sanitizeInput(nameInput.value);

        if (!playerName) {
            nameInput.classList.add('error-shake');
            setTimeout(() => nameInput.classList.remove('error-shake'), 500);
            return;
        }

        // G√©n√©rer un nouveau code de session
        const sessionId = generateSessionId();

        // Stocker le nom et le r√¥le
        localStorage.setItem('playerName', playerName);
        localStorage.setItem('playerRole', 'facilitator');

        // Rediriger vers la session
        window.location.href = `poker.html?session=${encodeURIComponent(sessionId)}&role=facilitator`;
    }

    function joinAsRole(role) {
        const nameInput = document.getElementById(role === 'facilitator' ? 'facilitatorName' : 'participantName');
        const sessionInput = document.getElementById(role === 'facilitator' ? 'facilitatorSessionCode' : 'participantSessionCode');

        const playerName = sanitizeInput(nameInput.value);
        const sessionCode = sanitizeInput(sessionInput.value.toLowerCase());

        if (!playerName) {
            nameInput.classList.add('error-shake');
            setTimeout(() => nameInput.classList.remove('error-shake'), 500);
            return;
        }

        if (!sessionCode) {
            sessionInput.classList.add('error-shake');
            setTimeout(() => sessionInput.classList.remove('error-shake'), 500);
            return;
        }

        // Stocker le nom et le r√¥le
        localStorage.setItem('playerName', playerName);
        localStorage.setItem('playerRole', role);

        // Rediriger vers la session
        window.location.href = `poker.html?session=${encodeURIComponent(sessionCode)}&role=${role}`;
    }

    function generateSessionId() {
        const adjectives = ['agile', 'rapide', 'super', 'mega', 'ultra', 'top'];
        const numbers = Math.floor(Math.random() * 100);
        const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
        return adj + numbers;
    }

    // Permettre Enter pour valider
    document.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            if (!document.getElementById('facilitatorForm').classList.contains('hidden')) {
                const sessionCode = document.getElementById('facilitatorSessionCode').value.trim();
                if (sessionCode) {
                    joinAsRole('facilitator');
                } else {
                    createSession();
                }
            } else if (!document.getElementById('participantForm').classList.contains('hidden')) {
                joinAsRole('participant');
            }
        }
    });
</script>
</body>
</html>