<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agile Poker Planning</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body>
<div class="container">
    <h1>ğŸ¯ Agile Poker Planning</h1>
    <p class="subtitle">
        Planning Poker en temps rÃ©el - Choisissez votre rÃ´le
    </p>

    <!-- Choix du rÃ´le -->
    <div id="roleChoice">
        <div class="role-buttons">
            <button class="role-btn facilitator" onclick="showFacilitatorForm()">
                ğŸ¬ Je suis le facilitateur
            </button>
            <button class="role-btn participant" onclick="showParticipantForm()">
                ğŸ‘¥ Je suis un participant
            </button>
        </div>
    </div>

    <!-- Formulaire Facilitateur -->
    <div id="facilitatorForm" class="hidden">
        <div class="form-box">
            <button class="back-link" onclick="showRoleChoice()">â† Retour</button>
            <h2>ğŸ¬ Facilitateur</h2>
            <p class="form-description">CrÃ©ez une nouvelle session et invitez votre Ã©quipe</p>

            <label for="facilitatorName"></label><input
                    type="text"
                    id="facilitatorName"
                    placeholder="Votre nom (ex: Claude)"
                    maxlength="20"
                    autocomplete="off"
            >

            <button class="btn btn-primary" onclick="createSession()">
                â• CrÃ©er une nouvelle session
            </button>

            <div class="divider">
                <span>OU</span>
            </div>

            <div class="join-existing">
                <p class="hint">Si vous avez dÃ©jÃ  une session en cours :</p>
                <label for="facilitatorSessionCode"></label><input
                        type="text"
                        id="facilitatorSessionCode"
                        placeholder="Code de session (ex: equipe37)"
                        maxlength="20"
                        autocomplete="off"
                        class="session-code-input"
                >
                <button class="btn btn-secondary" onclick="joinAsRole('facilitator')">
                    Rejoindre ma session
                </button>
            </div>
        </div>
    </div>

    <!-- Formulaire Participant -->
    <div id="participantForm" class="hidden">
        <div class="form-box">
            <button class="back-link" onclick="showRoleChoice()">â† Retour</button>
            <h2>ğŸ‘¥ Participant</h2>
            <p class="form-description">Rejoignez une session existante</p>

            <label for="participantName"></label><input
                    type="text"
                    id="participantName"
                    placeholder="Votre nom (ex: Alice)"
                    maxlength="20"
                    autocomplete="off"
            >

            <label for="participantSessionCode"></label><input
                    type="text"
                    id="participantSessionCode"
                    placeholder="Code de session (ex: equipe37)"
                    maxlength="20"
                    autocomplete="off"
                    class="session-code-input"
            >

            <button class="btn btn-primary" onclick="joinAsRole('participant')">
                Rejoindre la session
            </button>

            <p class="hint">ğŸ’¡ Le facilitateur vous a partagÃ© le code de session</p>
        </div>
    </div>
</div>

<!-- Gun.js -->
<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<script>
    // VÃ©rifier si une session existe dans l'URL
    const urlParams = new URLSearchParams(window.location.search);
    const existingSessionId = urlParams.get('session');
    const roleFromUrl = urlParams.get('role');

    if (existingSessionId) {
        // Si URL avec session, proposer directement de rejoindre
        if (roleFromUrl === 'facilitator') {
            showFacilitatorForm();
            document.getElementById('facilitatorSessionCode').value = existingSessionId;
        } else {
            showParticipantForm();
            document.getElementById('participantSessionCode').value = existingSessionId;
        }
    }

    function showRoleChoice() {
        document.getElementById('roleChoice').classList.remove('hidden');
        document.getElementById('facilitatorForm').classList.add('hidden');
        document.getElementById('participantForm').classList.add('hidden');
    }

    function showFacilitatorForm() {
        document.getElementById('roleChoice').classList.add('hidden');
        document.getElementById('facilitatorForm').classList.remove('hidden');
        document.getElementById('participantForm').classList.add('hidden');
        document.getElementById('facilitatorName').focus();
    }

    function showParticipantForm() {
        document.getElementById('roleChoice').classList.add('hidden');
        document.getElementById('facilitatorForm').classList.add('hidden');
        document.getElementById('participantForm').classList.remove('hidden');
        document.getElementById('participantName').focus();
    }

    function createSession() {
        const nameInput = document.getElementById('facilitatorName');
        const playerName = nameInput.value.trim();

        if (!playerName) {
            nameInput.classList.add('error-shake');
            setTimeout(() => nameInput.classList.remove('error-shake'), 500);
            return;
        }

        // GÃ©nÃ©rer un nouveau code de session
        const sessionId = generateSessionId();

        // Stocker le nom et le rÃ´le
        localStorage.setItem('playerName', playerName);
        localStorage.setItem('playerRole', 'facilitator');

        // Rediriger vers la session
        window.location.href = `poker.html?session=${sessionId}&role=facilitator`;
    }

    function joinAsRole(role) {
        const nameInput = document.getElementById(role === 'facilitator' ? 'facilitatorName' : 'participantName');
        const sessionInput = document.getElementById(role === 'facilitator' ? 'facilitatorSessionCode' : 'participantSessionCode');

        const playerName = nameInput.value.trim();
        const sessionCode = sessionInput.value.trim().toLowerCase();

        if (!playerName) {
            nameInput.classList.add('error-shake');
            setTimeout(() => nameInput.classList.remove('error-shake'), 500);
            return;
        }

        if (!sessionCode) {
            sessionInput.classList.add('error-shake');
            setTimeout(() => sessionInput.classList.remove('error-shake'), 500);
            return;
        }

        // Stocker le nom et le rÃ´le
        localStorage.setItem('playerName', playerName);
        localStorage.setItem('playerRole', role);

        // Rediriger vers la session
        window.location.href = `poker.html?session=${sessionCode}&role=${role}`;
    }

    function generateSessionId() {
        const adjectives = ['agile', 'rapide', 'super', 'mega', 'ultra', 'top'];
        const numbers = Math.floor(Math.random() * 100);
        const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
        return adj + numbers;
    }

    // Permettre Enter pour valider
    document.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            if (!document.getElementById('facilitatorForm').classList.contains('hidden')) {
                const sessionCode = document.getElementById('facilitatorSessionCode').value.trim();
                if (sessionCode) {
                    joinAsRole('facilitator');
                } else {
                    createSession();
                }
            } else if (!document.getElementById('participantForm').classList.contains('hidden')) {
                joinAsRole('participant');
            }
        }
    });
</script>
</body>

</html>
